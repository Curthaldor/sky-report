<!DOCTYPE html>
<html>
<head>
    <title>Aurora Activity Monitor</title>
    <style>
        body { font-family: Arial; padding: 2rem; background: #0c0f18; color: #cceeff; }
        .kp-box { font-size: 2rem; border: 2px solid #44ccff; padding: 1rem; border-radius: 10px; width: fit-content; }
    </style>
</head>
<body>
    <h1>üåå Aurora Activity Monitor</h1>
    <div class="kp-box">
        <p><strong>Kp Index:</strong> {{ kp.kp_index }}</p>
        <p><strong>Estimated:</strong> {{ kp.estimated_kp }}</p>
        <p><strong>Label:</strong> {{ kp.kp_label }}</p>
        <p><strong>Time:</strong> {{ kp.time }}</p>
    </div>
	
	<p id="location-display">üìç Detecting your location...</p>
    <p id="forecast-message"></p>
    <script>
      // Pass Kp index from Flask to JS
      const kpIndex = {{ kp.kp_index|default(0) }};
      function requestUserLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const lat = position.coords.latitude;
              const lon = position.coords.longitude;
              document.getElementById("location-display").textContent =
                `üåç You are at Latitude: ${lat.toFixed(2)}, Longitude: ${lon.toFixed(2)}`;

              function getAuroraLikelihood(kp, lat) {
                // Table: Kp index to lowest visible latitude
                const kpLatTable = {
                  9: 35,
                  8: 40,
                  7: 45,
                  6: 50,
                  5: 55,
                  4: 60,
                  3: 65,
                  2: 67,
                  1: 70
                };
                let thresholdLat = 70;
                for (let k = kp; k >= 1; k--) {
                  if (kpLatTable[k]) {
                    thresholdLat = kpLatTable[k];
                    break;
                  }
                }
                const absLat = Math.abs(lat);
                if (absLat >= thresholdLat) return 100;
                // Decrease likelihood by 10% for each degree south of threshold, minimum 0%
                let percent = 100 - (thresholdLat - absLat) * 10;
                return Math.max(0, Math.round(percent));
              }

              // Simple forecast logic
              const likelihood = getAuroraLikelihood(kpIndex, lat);
              let forecast = "";
              if (likelihood === 100) {
                forecast = "üåü Auroras very likely at your latitude! (100%)";
              } else if (likelihood >= 70) {
                forecast = `‚ú® Good chance of auroras at your latitude! (${likelihood}%)`;
              } else if (likelihood >= 30) {
                forecast = `üåå Low chance of auroras at your latitude. (${likelihood}%)`;
              } else {
                forecast = `‚ÑπÔ∏è Auroras very unlikely at your latitude. (${likelihood}%)`;
              }
              document.getElementById("forecast-message").textContent = forecast;
            },
            (error) => {
              document.getElementById("location-display").textContent =
                "‚ö†Ô∏è Unable to retrieve location.";
              // Fallback to default message
              document.getElementById("forecast-message").textContent =
                "{{ '‚úÖ Auroras may be visible at mid-latitudes!' if kp.kp_index >= 5 else '‚ÑπÔ∏è Auroras likely visible only near the poles.' }}";
            }
          );
        } else {
          document.getElementById("location-display").textContent =
            "‚ùå Geolocation is not supported by this browser.";
          document.getElementById("forecast-message").textContent =
            "{{ '‚úÖ Auroras may be visible at mid-latitudes!' if kp.kp_index >= 5 else '‚ÑπÔ∏è Auroras likely visible only near the poles.' }}";
        }
      }
      window.onload = requestUserLocation;
    </script>

    <!-- Remove or comment out the old Jinja forecast message -->
    {# 
    {% if kp.kp_index >= 5 %}
        <h2>‚úÖ Auroras may be visible at mid-latitudes!</h2>
    {% else %}
        <h2>‚ÑπÔ∏è Auroras likely visible only near the poles.</h2>
    {% endif %}
    #}
</body>
</html>
